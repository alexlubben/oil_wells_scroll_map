<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Louisiana Land Loss: A Scroll Story</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: system-ui, sans-serif;
      overflow-x: hidden;
    }

    #map {
      position: fixed;
      inset: 0;
      z-index: 0;
    }

    #scrolly {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 4vh 2vw;
    }

    .step {
      min-height: unset;
      margin-bottom: 80vh;
      padding: 1.5rem 2rem;
      width: fit-content;
      max-width: 350px;
      min-width: 280px;
      font-size: 1.1rem;
      line-height: 1.6;
      background: rgba(0, 0, 0, 0.95);
      color: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .step:hover {
      background: rgba(255, 255, 255, 0.98);
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
    }

    .step:last-child {
      margin-bottom: 100vh;
    }

    .step h3 {
      margin: 0 0 1rem 0;
      color: #fff;
      font-size: 1.4rem;
      font-weight: 600;
    }

    .step p {
      margin: 0;
      color: #fff;
    }

    /* Add visual indicator for active step */
    .step.active {
      background: rgba(0, 0, 0, 1);
      border-left: 4px solid #67000d;
    }
  </style>
</head>
<body>

<div id="map"></div>

<section id="scrolly">
  <div class="step" data-step="1">
    <p>In 1932, Louisiana's coastal wetlands extended far into what is now open water. Extensive marshlands protected inland communities.</p>
  </div>
  
  <div class="step" data-step="2">
    <p>Human activities and natural processes began reshaping the coast. River channelization and oil extraction disrupted the ecosystem.</p>
  </div>
  
  <div class="step" data-step="3">
    <p>Climate change effects compounded existing problems. Major hurricanes dramatically reshaped the coastline in just days.</p>
  </div>
  
  <div class="step" data-step="4">
    <p>Oil wells once on solid ground now sit in open water. Louisiana has lost over 1,900 square miles since the 1930s.</p>
  </div>

  <div class="step" data-step="5">
    <p>A new analysis from The Times-Picayune has found thousands of wells that were drilled on land that are now below the water's surface.</p>
  </div>

  <div class="step" data-step="6">
    <p>As sea levels rise, thousands more will become submerged.</p>
  </div>
  </section>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Initialize the map
const map = L.map('map', {
  center: [29.2, -89.4],
  zoom: 10,
  zoomControl: false,
  dragging: false,
  scrollWheelZoom: false,
  doubleClickZoom: false,
  boxZoom: false,
  touchZoom: false,
  keyboard: false
});

// Create the 2020 layer (base layer)
const layer2020 = L.tileLayer('tiles/2020/{z}/{x}/{y}.png', {
  minZoom: 7,
  maxZoom: 10,
  errorTileUrl: ''
}).addTo(map);

// Create the 1932 layer (overlay layer that will fade)
const layer1932 = L.tileLayer('tiles/1932/{z}/{x}/{y}.png', {
  opacity: 1,
  minZoom: 7,
  maxZoom: 10,
  errorTileUrl: ''
}).addTo(map);

// Handle scroll step changes with smooth gradual fade
function handleStepEnter(step, progress = 0) {
  console.log('Step entered:', step, 'Progress:', progress);
  
  // Remove active class from all steps
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  
  // Add active class to current step
  const currentStepElement = document.querySelector(`[data-step="${step}"]`);
  if (currentStepElement) {
    currentStepElement.classList.add('active');
  }
  
  // Smooth opacity fade with interpolation between steps
  let opacity;
  switch(step) {
    case 1:
      opacity = 1.0;
      break;
    case 2:
      opacity = 0.80;
      break;
    case 3:
      opacity = 0.60;
      break;
    case 4:
      opacity = 0.40;
      break;
    case 5:
      opacity = 0.2;
      break;
    case 6:
      opacity = 0
      break;
  }
  
  console.log(`Setting 1932 layer opacity to ${opacity}`);
  layer1932.setOpacity(opacity);
}

// Enhanced scroll detection with smooth transitions
function initScrollDetection() {
  const steps = document.querySelectorAll('.step');
  let currentStep = 0;

  function checkSteps() {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const windowHeight = window.innerHeight;
    const triggerPoint = windowHeight / 2;

    // Find which step we're in and calculate progress within that step
    steps.forEach((step, index) => {
      const stepTop = step.offsetTop;
      const stepBottom = stepTop + step.offsetHeight;
      const stepCenter = stepTop + (step.offsetHeight / 2);
      
      if (scrollTop + triggerPoint >= stepTop && scrollTop + triggerPoint <= stepBottom) {
        if (currentStep !== index + 1) {
          currentStep = index + 1;
          console.log('Pure JS detected step:', currentStep);
          
          // Calculate progress through the step (0 to 1)
          const stepProgress = Math.max(0, Math.min(1, 
            (scrollTop + triggerPoint - stepTop) / step.offsetHeight
          ));
          
          handleStepEnter(currentStep, stepProgress);
        }
      }
    });
  }

  // Throttle scroll events for better performance
  let ticking = false;
  function throttledCheckSteps() {
    if (!ticking) {
      requestAnimationFrame(() => {
        checkSteps();
        ticking = false;
      });
      ticking = true;
    }
  }

  window.addEventListener('scroll', throttledCheckSteps);
  checkSteps(); // Initial check
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing scroll detection');
  initScrollDetection();
});
</script>
</body>
</html>